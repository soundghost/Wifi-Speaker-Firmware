#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build IMM K2P

permissions: write-all
# å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  workflow_dispatch:
    inputs:
      LAN_IP:
        description: 'Set LAN IP Address'
        required: true
        default: '192.168.11.1'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FREE_DISK_SH: scripts/free_disk_space.sh
  ENV_SH: scripts/imm-environment.sh
  DIY_SH1: scripts/diy1.sh
  DIY_SH2: scripts/diy2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€æŸ¥
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        chmod +x $FREE_DISK_SH && $FREE_DISK_SH
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update -y
        sudo -E apt-get -qq full-upgrade -y
        chmod +x $ENV_SH && $ENV_SH
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        git clone $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: å¼€å¯ç¼“å­˜
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey: 'openwrt21-cortexa53'
        prefix: ${{ github.workspace }}/openwrt

    - name: æ›´æ–° & å®‰è£… feeds & æ‰§è¡Œè„šæœ¬
      run: |
        cd openwrt
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        #git fetch https://github.com/padavanonly/immortalwrt-mt798x
        #git merge FETCH_HEAD
        
        # æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH1" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH1 && $GITHUB_WORKSPACE/$DIY_SH1
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬1 $DIY_SH1 ä¸å­˜åœ¨ï¼Œæµç¨‹å°†ç»ˆæ­¢"
          exit 1
        fi

        # å»ºç«‹snapcastè½¯é“¾æ¥
        echo "å»ºç«‹snapcastè½¯é“¾æ¥"
        if ln -s snapos/openwrt package/snapcast; then
          echo "å»ºç«‹snapcastè½¯é“¾æ¥æˆåŠŸ"
        else
          echo "å»ºç«‹snapcastè½¯é“¾æ¥å¤±è´¥ï¼Œæµç¨‹å°†ç»ˆæ­¢"
          exit 1
        fi

        # æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH2" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH2 && $GITHUB_WORKSPACE/$DIY_SH2
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬2 $DIY_SH2 ä¸å­˜åœ¨ï¼Œæµç¨‹å°†ç»ˆæ­¢"
          exit 1
        fi
        
        # æ›´æ–° & å®‰è£… feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: å¯¼å…¥è¡¥ä¸å’Œé…ç½®
      run: |
        [ -e files ] && mv files openwrt/files
        cat configs/k2p-new.config >> openwrt/.config

    - name: è®¾ç½®LAN IPåœ°å€ï¼ˆè·¯ç”±å™¨ç™»å½•åœ°å€ï¼‰
      run: |
        cd openwrt
        SET_IP=${{ github.event.inputs.LAN_IP }}
        if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            #ä¿®æ”¹lanå…³è”IP
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" $(find feeds/luci/modules/luci-mod-system -type f -name "flash.js")
            #ä¿®æ”¹é»˜è®¤IPåœ°å€
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            echo "è®¾ç½® LAN å£ IP åœ°å€ä¸º $SET_IP æˆåŠŸï¼"
        else
            echo "æ— æ•ˆ IP åœ°å€, å°†ä½¿ç”¨é»˜è®¤åœ°å€ã€‚"
        fi

    - name: ä¸‹è½½æ–‡ä»¶
      run: |
        cd openwrt
        make defconfig
        make download -j8 V=10
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶ä¸­
      id: compile
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make -j$(($(nproc)+1)) || make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf *.buildinfo 
        rm -rf *.json 
        rm -rf *.manifest 
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        echo -e "### K2P 32M USB Firmware" >> release.txt
        wlan_luci_interface=""
        if grep -q 'CONFIG_PACKAGE_mtwifi-cfg=y' openwrt/.config; then
          echo "- ä½¿ç”¨ OpenWrt åŸç”Ÿæ— çº¿æ§åˆ¶ç•Œé¢" >> release.txt
          wlan_luci_interface="mtwifi-cfg"
        else
          echo "- ä½¿ç”¨ MTK SDK æ— çº¿æ§åˆ¶ç•Œé¢" >> release.txt
          wlan_luci_interface="luci-app-mtk"
        fi
        eeprom_status=""
        if [ -e openwrt/target/linux/mediatek/mt7981/base-files/lib/firmware/MT7981_iPAiLNA_EEPROM.bin ] ; then
          echo "- eeprom ä½¿ç”¨ H3C NX30 Pro æå–ç‰ˆæœ¬" >> release.txt
          eeprom_status="nx30pro_eeprom"
        else
          echo "" >> release.txt
          eeprom_status="default_eeprom"
        fi
        max_frequency=$(($(grep -oP "max-frequency = <\K[0-9]*" openwrt/target/linux/mediatek/files-5.4/arch/arm64/boot/dts/mediatek/mt7981-cmcc-rax3000m-emmc.dts) / 1000000))
        echo "" >> release.txt
        release_tag=$(date +"%Y.%m.%d-imm-23.05-k2p-32M-USB")
        echo "release_tag=${release_tag}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§å‘å¸ƒçš„å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 7
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ é™¤è¿‡æ—¶å·¥ä½œæµç¨‹
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 3
