#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build ImmortalWrt rax3000m emmc

permissions: write-all
# å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  workflow_dispatch:
    inputs:
      LAN_IP:
        description: 'Set LAN IP Address'
        required: true
        default: '192.168.1.1'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05

  ENV_SH: scripts/environment.sh
  DIY_SH1: scripts/diy1.sh
  DIY_SH2: scripts/diy2.sh

  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€æŸ¥
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆç³»ç»Ÿæ¸…ç†ï¼‰
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†ç³»ç»Ÿç©ºé—´..."
        # æ˜¾ç¤ºæ¸…ç†å‰çš„ç©ºé—´ä½¿ç”¨æƒ…å†µ
        echo "æ¸…ç†å‰çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        # åˆ é™¤å¤§å‹è½¯ä»¶åŒ…å’Œå·¥å…·é“¾
        echo "æ¸…ç†dotnet"
        sudo rm -rf /usr/share/dotnet
        echo "æ¸…ç†anroid"
        sudo rm -rf /usr/local/lib/android
        echo "æ¸…ç†ghc"
        sudo rm -rf /opt/ghc
        echo "æ¸…ç†boost"
        sudo rm -rf /usr/local/share/boost
        echo "æ¸…ç†hostedtoolcache"
        sudo rm -rf /opt/hostedtoolcache
        echo "æ¸…ç†.ghcup"
        sudo rm -rf /usr/local/.ghcup
        echo "æ¸…ç†swift"
        sudo rm -rf /usr/share/swift
        # æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
        sudo apt-get clean
        sudo apt-get autoremove -y --purge
        # æ¸…ç† Dockerï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if command -v docker > /dev/null 2>&1; then
          echo "æ¸…ç†Docker"
          docker system prune -a -f || true
        fi
        # æ¸…ç† snap ç¼“å­˜
        if command -v snap > /dev/null 2>&1; then
          sudo snap list --all | awk '/disabled/{print $1, $3}' | while read snapname revision; do
            echo "æ¸…ç† snap ç¼“å­˜"
            sudo snap remove "$snapname" --revision="$revision" 2>/dev/null || true
          done
        fi
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶tmp"
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        echo "âœ… ç³»ç»Ÿç©ºé—´æ¸…ç†å®Œæˆ"
        echo "æ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        sudo -E apt-get -qq update -y
        # å‡çº§ç³»ç»Ÿï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦å¯ç”¨ï¼‰
        # sudo -E apt-get -qq full-upgrade -y
        chmod +x $ENV_SH && $ENV_SH
        sudo timedatectl set-timezone "$TZ"
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: |
        echo "ğŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        echo ""
        echo "ğŸ“ /workdir ç›®å½•ä¿¡æ¯ï¼š"
        ls -la /workdir/ || echo "ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        echo "ğŸ“¥ å¼€å§‹å…‹éš†æºç ..."
        git clone --depth 1 $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        
        # æ˜¾ç¤ºæºç ä¿¡æ¯
        cd openwrt
        echo "ğŸ“‹ æºç ä¿¡æ¯:"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo "æäº¤: $(git log --oneline -1)"

    - name: æ›´æ–° feeds å¹¶å®‰è£…ä¾èµ–
      run: |
        cd openwrt
        # é…ç½® git ç”¨æˆ·ä¿¡æ¯
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        echo "ğŸ“¦ æ›´æ–° feeds..."
        ./scripts/feeds update -a
        echo "ğŸ“¦ å®‰è£… feeds..."
        ./scripts/feeds install -a
        # æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH1" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH1 && $GITHUB_WORKSPACE/$DIY_SH1
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬1 $DIY_SH1 ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        # æ›´æ–° golang åˆ° 1.25.x ç‰ˆæœ¬
        echo "ğŸ”„ æ›´æ–° golang åˆ° 1.25.x ..."
        rm -rf feeds/packages/lang/golang
        if git clone https://github.com/sbwml/packages_lang_golang -b 25.x feeds/packages/lang/golang; then
          echo "âœ… golang æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ golang æ›´æ–°å¤±è´¥ï¼Œå³å°†é€€å‡ºç¨‹åº"
          exit 1
        fi

        # æ›´æ–° xray-core Makefile
        echo "ğŸ”„ æ›´æ–° xray-core Makefile..."
        if curl -sSL https://raw.githubusercontent.com/immortalwrt/packages/refs/heads/master/net/xray-core/Makefile -o package/feeds/packages/xray-core/Makefile; then
          echo "âœ… xray-core Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ xray-core Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi

        # æ›´æ–° upmpdcli Makefile
        echo "ğŸ”„ æ›´æ–° upmpdcli Makefile..."
        if curl -sSL https://github.com/immortalwrt/packages/raw/refs/heads/master/sound/upmpdcli/Makefile -o feeds/packages/sound/upmpdcli/Makefile; then
          echo "âœ… upmpdcli Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ upmpdcli Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi

        # æ›´æ–° mpd
        echo "ğŸ”„ æ›´æ–° mpd Makefile..."
        if curl -sSL https://github.com/immortalwrt/packages/raw/refs/heads/master/sound/mpd/Makefile -o feeds/packages/sound/mpd/Makefile; then
          echo "âœ… mpd Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ mpd Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi
        if curl -sSL https://github.com/immortalwrt/packages/raw/refs/heads/master/sound/mpd/patches/010-fmt.patch -o feeds/packages/sound/mpd/patches/010-fmt.patch; then
          echo "âœ… mpd patches æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ mpd patches æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi

        # æ›´æ–° pianod Makefile
        echo "ğŸ”„ æ›´æ–° pianod Makefile..."
        if curl -sSL https://github.com/immortalwrt/packages/raw/refs/heads/master/sound/pianod/Makefile -o feeds/packages/sound/pianod/Makefile; then
          echo "âœ… pianod Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ pianod Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi

        # æ›´æ–° mpg123 Makefile
        echo "ğŸ”„ æ›´æ–° mpg123 Makefile..."
        if curl -sSL https://github.com/immortalwrt/packages/raw/refs/heads/master/sound/mpg123/Makefile -o feeds/packages/sound/mpg123/Makefile; then
          echo "âœ… mpg123 Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ mpg123 Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi

        # å»ºç«‹snapcastè½¯é“¾æ¥
        echo "å»ºç«‹snapcastè½¯é“¾æ¥"
        if ln -s snapos/openwrt package/snapcast; then
          echo "å»ºç«‹snapcastè½¯é“¾æ¥æˆåŠŸ"
        else
          echo "å»ºç«‹snapcastè½¯é“¾æ¥å¤±è´¥ï¼Œæµç¨‹å°†ç»ˆæ­¢"
          exit 1
        fi
        # æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH2" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH2 && $GITHUB_WORKSPACE/$DIY_SH2
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬2 $DIY_SH2 ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
    - name: å¯¼å…¥è¡¥ä¸å’ŒåŸºç¡€é…ç½®
      run: |
        echo "âš™ï¸ å¯¼å…¥é…ç½®æ–‡ä»¶..."
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
        if [ -d "files" ]; then
          echo "ğŸ“ å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶..."
          mv files openwrt/files
        fi
        # å¯¼å…¥åŸºç¡€é…ç½®
        if [ -f "configs/k3.config" ]; then
          echo "ğŸ“‹ å¯¼å…¥åŸºç¡€é…ç½®..."
          cat configs/k3.config >> openwrt/.config
        else
          echo "âŒ åŸºç¡€é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: configs/k3.config"
          exit 1
        fi

    - name: è®¾ç½®LAN IPåœ°å€ï¼ˆè·¯ç”±å™¨ç™»å½•åœ°å€ï¼‰
      run: |
        cd openwrt
        SET_IP=${{ github.event.inputs.LAN_IP }}
        if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            #ä¿®æ”¹lanå…³è”IP
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" $(find feeds/luci/modules/luci-mod-system -type f -name "flash.js")
            #ä¿®æ”¹é»˜è®¤IPåœ°å€
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            echo "è®¾ç½® LAN å£ IP åœ°å€ä¸º $SET_IP æˆåŠŸï¼"
        else
            echo "æ— æ•ˆ IP åœ°å€, å°†ä½¿ç”¨é»˜è®¤åœ°å€ã€‚"
        fi

    - name: ä¸‹è½½ä¾èµ–
      run: |
        cd openwrt
       
        # ç”Ÿæˆé»˜è®¤é…ç½®
        echo "âš™ï¸ ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        # ä¸‹è½½ç¼–è¯‘ä¾èµ–
        echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
        make download -j$(nproc) V=10
        
        # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶..."
        find dl -size -1024c -exec rm -f {} \;
        echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶ä¸­
      id: compile
      run: |
        cd openwrt
        # æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "ç¼–è¯‘çº¿ç¨‹æ•°: $(($(nproc)+1))"
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
        free -h
        # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥æ—¶é€æ­¥é™çº§
        compile_success=false
        if make -j$(($(nproc)+1)); then
          compile_success=true
          echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
        elif make -j$(nproc); then
          compile_success=true
          echo "âœ… æ ‡å‡†å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
        elif make -j1 V=s; then
          compile_success=true
          echo "âœ… å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘æˆåŠŸ"
        fi
        # è®°å½•ç¼–è¯‘ç»“æŸæ—¶é—´
        compile_end=$(date '+%Y-%m-%d %H:%M:%S')
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $compile_end"
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ "$compile_success" = "true" ] && [ -d "bin/targets" ]; then
          firmware_count=$(find bin/targets -name "*.bin" -o -name "*.img" | wc -l)
          if [ $firmware_count -gt 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼Œç”Ÿæˆäº† $firmware_count ä¸ªå›ºä»¶æ–‡ä»¶"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "compile_time=$(date '+%Y.%m.%d_%H:%M:%S')" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: æ£€æŸ¥ç¼–è¯‘åç©ºé—´ä½¿ç”¨
      if: (!cancelled())
      run: |
        echo "ğŸ“Š ç¼–è¯‘åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        echo ""
        echo "ğŸ“ ç¼–è¯‘è¾“å‡ºç›®å½•å¤§å°ï¼š"
        if [ -d "openwrt/bin" ]; then
          du -sh openwrt/bin
        fi

    - name: ä¸Šä¼  bin ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf *.buildinfo 
        rm -rf *.json 
        rm -rf *.manifest 
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        echo -e "### immortalwrt-23.05-wifi-speaker--phicomm-k3" >> release.txt

        release_tag=$(date +"%Y.%m.%d-23.05-wifi-speaker-phicomm-K3")
        echo "release_tag=${release_tag}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§å‘å¸ƒçš„å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 7
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ é™¤è¿‡æ—¶å·¥ä½œæµç¨‹
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 3
