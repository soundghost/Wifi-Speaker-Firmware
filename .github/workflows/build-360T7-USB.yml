#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build 360T7 USB

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      USE_MTWIFI_CFG:
        description: 'Use mtwifi-cfg'
        required: true
        default: false
        type: boolean
      CLEAN_CACHE:
        description: 'æ‰‹åŠ¨æ¸…ç†ç¼“å­˜å¹¶å¼ºåˆ¶å…¨æ–°ç¼–è¯‘'
        required: true
        default: false
        type: boolean
      LAN_IP:
        description: 'Set LAN IP Address'
        required: true
        default: '192.168.1.1'

env:
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
  ENV_SH: scripts/environment.sh
  DIY_SH1: scripts/diy1.sh
  DIY_SH2: scripts/diy2.sh
  #CLASH_CORE: scripts/preset-clash-core.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  DEVICE_NAME: 360T7 USB
  CCACHE_DIR: ~/.ccache
  CCACHE_MAXSIZE: 2G

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€æŸ¥é¡¹ç›®æ–‡ä»¶
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "USE_MTWIFI_CFG=${{ github.event.inputs.USE_MTWIFI_CFG }}" >> $GITHUB_ENV
        echo "USE_NX30PRO_EEPROM=${{ github.event.inputs.USE_NX30PRO_EEPROM }}" >> $GITHUB_ENV
        echo "USE_52MHZ=${{ github.event.inputs.USE_52MHZ }}" >> $GITHUB_ENV
        echo "CLEAN_CACHE=${{ github.event.inputs.CLEAN_CACHE }}" >> $GITHUB_ENV



    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆç³»ç»Ÿæ¸…ç†ï¼‰
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†ç³»ç»Ÿç©ºé—´..."
        
        # æ˜¾ç¤ºæ¸…ç†å‰çš„ç©ºé—´ä½¿ç”¨æƒ…å†µ
        echo "æ¸…ç†å‰çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        
        # åˆ é™¤å¤§å‹è½¯ä»¶åŒ…å’Œå·¥å…·é“¾
        echo "ğŸ§¹ æ¸…ç†dotnet"
        sudo rm -rf /usr/share/dotnet
        echo "ğŸ§¹ æ¸…ç†anroid"
        sudo rm -rf /usr/local/lib/android
        echo "ğŸ§¹ æ¸…ç†ghc"
        sudo rm -rf /opt/ghc
        echo "ğŸ§¹ æ¸…ç†boost"
        sudo rm -rf /usr/local/share/boost
        echo "ğŸ§¹ æ¸…ç†hostedtoolcache"
        sudo rm -rf /opt/hostedtoolcache
        echo "ğŸ§¹ æ¸…ç†.ghcup"
        sudo rm -rf /usr/local/.ghcup
        echo "ğŸ§¹ æ¸…ç†swift"
        sudo rm -rf /usr/share/swift
        
        # æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
        sudo apt-get clean
        sudo apt-get autoremove -y --purge
        
        # æ¸…ç† Dockerï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if command -v docker > /dev/null 2>&1; then
          echo "ğŸ§¹ æ¸…ç†Docker"
          docker system prune -a -f || true
        fi
        
        # æ¸…ç† snap ç¼“å­˜
        if command -v snap > /dev/null 2>&1; then
          sudo snap list --all | awk '/disabled/{print $1, $3}' | while read snapname revision; do
            echo "ğŸ§¹ æ¸…ç† snap ç¼“å­˜"
            sudo snap remove "$snapname" --revision="$revision" 2>/dev/null || true
          done
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶tmp"
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        echo "âœ… ç³»ç»Ÿç©ºé—´æ¸…ç†å®Œæˆ"
        echo "æ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT



    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        
        # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        sudo -E apt-get -qq update -y
        
        # å‡çº§ç³»ç»Ÿï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦å¯ç”¨ï¼‰
        # sudo -E apt-get -qq full-upgrade -y
        
        # æ‰§è¡Œç¯å¢ƒè®¾ç½®è„šæœ¬
        if [ -f "$ENV_SH" ]; then
          chmod +x $ENV_SH && $ENV_SH
        else
          echo "âš ï¸ ç¯å¢ƒè®¾ç½®è„šæœ¬ $ENV_SH ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        

        
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: |
        echo "ğŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        echo ""
        echo "ğŸ“ /workdir ç›®å½•ä¿¡æ¯ï¼š"
        ls -la /workdir/ || echo "ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        echo "ğŸ“¥ å¼€å§‹å…‹éš†æºç ..."
        git clone --depth 1 $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        
        # æ˜¾ç¤ºæºç ä¿¡æ¯
        cd openwrt
        echo "ğŸ“‹ æºç ä¿¡æ¯:"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo "æäº¤: $(git log --oneline -1)"

    - name: æ›´æ–° feeds å¹¶å®‰è£…ä¾èµ–
      run: |
        cd openwrt
        
        # é…ç½® git ç”¨æˆ·ä¿¡æ¯
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        echo "ğŸ“¦ æ›´æ–° feeds..."
        ./scripts/feeds update -a
        
        echo "ğŸ“¦ å®‰è£… feeds..."
        ./scripts/feeds install -a
        
        # æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH1" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 1 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH1 && $GITHUB_WORKSPACE/$DIY_SH1
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬1 $DIY_SH1 ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        # æ›´æ–° golang åˆ° 1.25.x ç‰ˆæœ¬
        echo "ğŸ”„ æ›´æ–° golang åˆ° 1.25.x ..."
        rm -rf feeds/packages/lang/golang
        if git clone https://github.com/sbwml/packages_lang_golang -b 25.x feeds/packages/lang/golang; then
          echo "âœ… golang æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ golang æ›´æ–°å¤±è´¥ï¼Œå³å°†é€€å‡ºç¨‹åº"
          exit 1
        fi
        # æ›´æ–° xray-core Makefile
        echo "ğŸ”„ æ›´æ–° xray-core Makefile..."
        if curl -sSL https://raw.githubusercontent.com/immortalwrt/packages/refs/heads/master/net/xray-core/Makefile -o package/feeds/packages/xray-core/Makefile; then
          echo "âœ… xray-core Makefile æ›´æ–°æˆåŠŸ"
        else
          echo "âš ï¸ xray-core Makefile æ›´æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç‰ˆæœ¬"
        fi
        # å»ºç«‹snapcastè½¯é“¾æ¥
        echo "å»ºç«‹snapcastè½¯é“¾æ¥"
        if ln -s snapos/openwrt package/snapcast; then
          echo "å»ºç«‹snapcastè½¯é“¾æ¥æˆåŠŸ"
        else
          echo "å»ºç«‹snapcastè½¯é“¾æ¥å¤±è´¥ï¼Œæµç¨‹å°†ç»ˆæ­¢"
          exit 1
        fi
        
        # æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/$DIY_SH2" ]; then
          echo "ğŸ”§ æ‰§è¡Œç¬¬ 2 ä¸ªè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
          chmod +x $GITHUB_WORKSPACE/$DIY_SH2 && $GITHUB_WORKSPACE/$DIY_SH2
        else
          echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬2 $DIY_SH2 ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: å¯¼å…¥è¡¥ä¸å’ŒåŸºç¡€é…ç½®
      run: |
        echo "âš™ï¸ å¯¼å…¥é…ç½®æ–‡ä»¶..."
        
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
        if [ -d "files" ]; then
          echo "ğŸ“ å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶..."
          mv files openwrt/files
        fi
        
        # å¯¼å…¥åŸºç¡€é…ç½®
        if [ -f "configs/360T7-USB.config" ]; then
          echo "ğŸ“‹ å¯¼å…¥åŸºç¡€é…ç½®..."
          cat configs/360T7-USB.config >> openwrt/.config
        else
          echo "âŒ åŸºç¡€é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: configs/360T7-USB.config"
          exit 1
        fi

    - name: é…ç½®æ— çº¿æ§åˆ¶ç•Œé¢
      if: env.USE_MTWIFI_CFG == 'true'
      run: |
        echo "ğŸ“¡ é…ç½®ä½¿ç”¨ mtwifi-cfg æ— çº¿æ§åˆ¶ç•Œé¢..."
        cd openwrt
        
        # å¤‡ä»½åŸé…ç½®
        cp .config .config.bak
        
        # æ›¿æ¢æ— çº¿æ§åˆ¶é…ç½®
        if sed -i '/CONFIG_PACKAGE_luci-app-mtk=y/{N;N;N;s/CONFIG_PACKAGE_luci-app-mtk=y\nCONFIG_PACKAGE_luci-i18n-mtk-zh-cn=y\nCONFIG_PACKAGE_wifi-profile=y\nCONFIG_WIFI_NORMAL_SETTING=y/CONFIG_PACKAGE_lua-cjson=y\nCONFIG_PACKAGE_luci-app-mtwifi-cfg=y\nCONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y\nCONFIG_PACKAGE_mtwifi-cfg=y/}' .config; then
          echo "âœ… æ— çº¿æ§åˆ¶ç•Œé¢é…ç½®å®Œæˆ"
        else
          echo "âš ï¸ æ— çº¿æ§åˆ¶ç•Œé¢é…ç½®å¯èƒ½å¤±è´¥ï¼Œæ£€æŸ¥é…ç½®..."
          diff .config.bak .config || true
        fi

    - name: é…ç½®ç¬¬ä¸‰æ–¹ eeprom
      if: env.USE_NX30PRO_EEPROM == 'true'
      run: |
        echo "ğŸ“¡ é…ç½®ä½¿ç”¨ nx30pro eeprom..."
        cd openwrt
        
        # åˆ›å»ºå›ºä»¶ç›®å½•
        target_dir="target/linux/mediatek/mt7981/base-files/lib/firmware"
        mkdir -p "$target_dir"
        
        # å¤åˆ¶ eeprom æ–‡ä»¶
        if [ -f "$GITHUB_WORKSPACE/eeprom/nx30pro_eeprom.bin" ]; then
          cp "$GITHUB_WORKSPACE/eeprom/nx30pro_eeprom.bin" "$target_dir/MT7981_iPAiLNA_EEPROM.bin"
          echo "âœ… nx30pro eeprom æ–‡ä»¶å¤åˆ¶æˆåŠŸ"
        else
          echo "âŒ nx30pro eeprom æ–‡ä»¶ä¸å­˜åœ¨: eeprom/nx30pro_eeprom.bin"
          exit 1
        fi
        
        # ä¿®æ”¹ç›¸å…³é…ç½®æ–‡ä»¶
        preinit_file="target/linux/mediatek/mt7981/base-files/lib/preinit/90_extract_caldata"
        if [ -f "$preinit_file" ]; then
          sed -i 's/caldata_extract_mmc/# caldata_extract_mmc/' "$preinit_file"
          echo "âœ… preinit è„šæœ¬ä¿®æ”¹å®Œæˆ"
        fi
        
        makefile_path="package/mtk/drivers/mt_wifi/Makefile"
        if [ -f "$makefile_path" ]; then
          sed -i 's#./files/mt7981-default-eeprom/MT7981_iPAiLNA_EEPROM.bin##' "$makefile_path"
          echo "âœ… WiFi é©±åŠ¨ Makefile ä¿®æ”¹å®Œæˆ"
        fi

    - name: é…ç½®é—ªå­˜é¢‘ç‡
      if: env.USE_52MHZ == 'true'
      run: |
        echo "âš¡ é…ç½®ä½¿ç”¨ 52MHz é—ªå­˜é¢‘ç‡..."
        cd openwrt
        
        dts_file="target/linux/mediatek/files-5.4/arch/arm64/boot/dts/mediatek/mt7981-cmcc-rax3000m-emmc.dts"
        
        if [ -f "$dts_file" ]; then
          # æ·»åŠ é«˜é€Ÿæ¨¡å¼é…ç½®
          sed -i -e '/bus-width = <8>;/ a\	cap-mmc-highspeed;' "$dts_file"
          
          # ä¿®æ”¹é¢‘ç‡è®¾ç½®
          sed -i 's/26000000/52000000/g' "$dts_file"
          
          echo "âœ… é—ªå­˜é¢‘ç‡é…ç½®å®Œæˆ"
          echo "å½“å‰ max-frequency é…ç½®:"
          grep max-frequency "$dts_file" || echo "æœªæ‰¾åˆ° max-frequency é…ç½®"
        else
          echo "âŒ DTS æ–‡ä»¶ä¸å­˜åœ¨: $dts_file"
          exit 1
        fi

    - name: è®¾ç½®LAN IPåœ°å€ï¼ˆè·¯ç”±å™¨ç™»å½•åœ°å€ï¼‰
      run: |
        cd openwrt
        SET_IP=${{ github.event.inputs.LAN_IP }}
        if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            #ä¿®æ”¹lanå…³è”IP
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" $(find feeds/luci/modules/luci-mod-system -type f -name "flash.js")
            #ä¿®æ”¹é»˜è®¤IPåœ°å€
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            echo "è®¾ç½® LAN å£ IP åœ°å€ä¸º $SET_IP æˆåŠŸï¼"
        else
            echo "æ— æ•ˆ IP åœ°å€, å°†ä½¿ç”¨é»˜è®¤åœ°å€ã€‚"
        fi
    - name: ä¸‹è½½ä¾èµ–
      run: |
        cd openwrt
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        echo "âš™ï¸ ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        # ä¸‹è½½ç¼–è¯‘ä¾èµ–
        echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
        make download -j$(nproc) V=10
        
        # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶..."
        find dl -size -1024c -exec rm -f {} \;
        
        echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        
        # æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "ç¼–è¯‘çº¿ç¨‹æ•°: $(($(nproc)+1))"
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
        free -h
        
        # è®°å½•ç¼–è¯‘å¼€å§‹æ—¶é—´
        compile_start=$(date '+%Y-%m-%d %H:%M:%S')
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $compile_start"
        
        # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥æ—¶é€æ­¥é™çº§
        compile_success=false
        
        if make -j$(($(nproc)+1)); then
          compile_success=true
          echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
        elif make -j$(nproc); then
          compile_success=true
          echo "âœ… æ ‡å‡†å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
        elif make -j1 V=s; then
          compile_success=true
          echo "âœ… å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘æˆåŠŸ"
        fi
        
        # è®°å½•ç¼–è¯‘ç»“æŸæ—¶é—´
        compile_end=$(date '+%Y-%m-%d %H:%M:%S')
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $compile_end"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ "$compile_success" = "true" ] && [ -d "bin/targets" ]; then
          firmware_count=$(find bin/targets -name "*.bin" -o -name "*.img" | wc -l)
          if [ $firmware_count -gt 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼Œç”Ÿæˆäº† $firmware_count ä¸ªå›ºä»¶æ–‡ä»¶"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "compile_time=$(date '+%Y.%m.%d_%H:%M:%S')" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: æ£€æŸ¥ç¼–è¯‘åç©ºé—´ä½¿ç”¨
      if: (!cancelled())
      run: |
        echo "ğŸ“Š ç¼–è¯‘åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
        echo ""
        echo "ğŸ“ ç¼–è¯‘è¾“å‡ºç›®å½•å¤§å°ï¼š"
        if [ -d "openwrt/bin" ]; then
          du -sh openwrt/bin
        fi

    - name: ä¸Šä¼  bin ç›®å½•åˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin_${{ env.DEVICE_NAME }}_${{ steps.compile.outputs.compile_time }}
        path: openwrt/bin
        retention-days: 5

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        
        # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        rm -rf *.buildinfo *.json *.manifest packages
        
        # æ˜¾ç¤ºå‰©ä½™æ–‡ä»¶
        echo "ğŸ“ å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_${{ env.DEVICE_NAME }}_${{ steps.compile.outputs.compile_time }}
        path: ${{ env.FIRMWARE }}
        retention-days: 7

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œè¯´æ˜
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        echo "ğŸ·ï¸ ç”Ÿæˆå‘å¸ƒæ ‡ç­¾..."
        
        # è·å–ç¼–è¯‘å®Œæˆæ—¶é—´
        compile_time="${{ steps.compile.outputs.compile_time }}"
        
        # ç¡®å®šWiFiæ§åˆ¶ç•Œé¢ç±»å‹
        wlan_interface="unknown"
        if grep -q 'CONFIG_PACKAGE_mtwifi-cfg=y' openwrt/.config; then
          echo "- ğŸŒ ä½¿ç”¨ OpenWrt åŸç”Ÿæ— çº¿æ§åˆ¶ç•Œé¢ (mtwifi-cfg)" >> release.txt
          wlan_interface="mtwifi-cfg"
        elif grep -q 'CONFIG_PACKAGE_luci-app-mtk=y' openwrt/.config; then
          echo "- ğŸŒ ä½¿ç”¨ MTK SDK æ— çº¿æ§åˆ¶ç•Œé¢ (luci-app-mtk)" >> release.txt  
          wlan_interface="luci-app-mtk"
        else
          echo "- â“ æœªçŸ¥æ— çº¿æ§åˆ¶ç•Œé¢ç±»å‹" >> release.txt
        fi
        
        # ç¡®å®š eeprom çŠ¶æ€
        eeprom_status="default_eeprom"
        if [ -f "openwrt/target/linux/mediatek/mt7981/base-files/lib/firmware/MT7981_iPAiLNA_EEPROM.bin" ]; then
          echo "- ğŸ“¡ eeprom ä½¿ç”¨ H3C NX30 Pro æå–ç‰ˆæœ¬" >> release.txt
          eeprom_status="nx30pro_eeprom"
        else
          echo "- ğŸ“¡ ä½¿ç”¨é»˜è®¤ eeprom è®¾ç½®" >> release.txt
        fi
        
        # è·å–é—ªå­˜é¢‘ç‡é…ç½®
        dts_file="openwrt/target/linux/mediatek/files-5.4/arch/arm64/boot/dts/mediatek/mt7981-cmcc-rax3000m-emmc.dts"
        max_frequency="unknown"
        if [ -f "$dts_file" ]; then
          max_frequency_hz=$(grep -oP "max-frequency = <\K[0-9]*" "$dts_file" | head -1)
          if [ -n "$max_frequency_hz" ] && [ "$max_frequency_hz" -gt 0 ]; then
            max_frequency=$((max_frequency_hz / 1000000))
            echo "- âš¡ é—ªå­˜é¢‘ç‡: ${max_frequency}MHz" >> release.txt
          else
            echo "- âš¡ é—ªå­˜é¢‘ç‡: é»˜è®¤è®¾ç½®" >> release.txt
            max_frequency="default"
          fi
        else
          echo "- âš¡ é—ªå­˜é¢‘ç‡: é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°" >> release.txt
        fi
        
        # æ·»åŠ ç¼–è¯‘ä¿¡æ¯
        echo "" >> release.txt
        echo "## ğŸ“‹ ç¼–è¯‘ä¿¡æ¯" >> release.txt
        echo "- ğŸ• ç¼–è¯‘å®Œæˆæ—¶é—´: $compile_time" >> release.txt
        echo "- ğŸ–¥ï¸ ç¼–è¯‘ç¯å¢ƒ: Ubuntu 22.04" >> release.txt
        echo "- ğŸ”§ golang ver:1.25.x | xray-core ver:25.8.3" >> release.txt
        echo "- ğŸ“¦ åŒ…å«ä»¥ä¸‹éŸ³ä¹ç±»è½¯ä»¶ï¼šairconnect | airplay2 | upmpdcli | ympd | pianod | snapcast ( server | client )" >> release.txt
        
        # æ·»åŠ æºç ä¿¡æ¯
        echo "" >> release.txt
        echo "## ğŸ“¦ æºç ä¿¡æ¯" >> release.txt
        cd openwrt
        echo "- ğŸ“ ä»“åº“: $REPO_URL" >> ../release.txt
        echo "- ğŸŒ¿ åˆ†æ”¯: $(git branch --show-current)" >> ../release.txt
        echo "- ğŸ“ æäº¤: $(git log --oneline -1)" >> ../release.txt
        cd ..
        
        # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾ï¼ˆæŒ‰è¦æ±‚æ ¼å¼ï¼šç¼–è¯‘å®Œæˆæ—¶é—´ - å›ºä»¶å‹å· - WiFiæ§åˆ¶æ–¹å¼ - ç¬¬ä¸‰æ–¹eepromï¼‰
        release_tag=$(date +"%Y.%m.%d-mt7981-rax3000m-emmc-${wlan_interface}-${eeprom_status}")
        
        # æ·»åŠ é¢‘ç‡ä¿¡æ¯åˆ°æ ‡ç­¾ï¼ˆå¦‚æœä¸æ˜¯é»˜è®¤å€¼ï¼‰
        if [ "$max_frequency" != "default" ] && [ "$max_frequency" != "unknown" ]; then
          release_tag="${release_tag}-${max_frequency}MHz"
        fi
        
        echo "ğŸ·ï¸ å‘å¸ƒæ ‡ç­¾: $release_tag"
        echo "release_tag=${release_tag}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒå›ºä»¶åˆ° Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false

    - name: æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒ
      uses: dev-drprasad/delete-older-releases@v0.3.0
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 7
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†è¿‡æ—¶çš„å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@v2
      if: always()
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 3
